# Speakr Service Contract

This document is the single source of truth for the `speakr` service's functionality. It defines the commands the service accepts and the events it emits. All interactions with the service, whether from the CLI or a NATS message, must adhere to this contract.

---

### Data Model Concepts

-   **`recording_id`**: A unique UUID (`string`) generated by the service to identify a single, stateful recording session from start to finish.
-   **`tags`**: An optional array of strings (`[]string`) that provides user-defined, queryable metadata. Tags are carried through the entire lifecycle of a process.
-   **`metadata`**: An optional key-value map (`map[string]interface{}`) used to pass arbitrary, transient data through the system. This is useful for adapter-specific logic.

---

## 1. Commands

Commands are messages sent **to** the `speakr` service to request an action.

### `speakr.command.recording.start`

Starts a new recording session.

**Payload (JSON):**
```json
{
  "output_format": "wav",
  "tags": ["project-x", "daily-standup"],
  "metadata": { "triggered_by": "cli-adapter" }
}
```

### `speakr.command.recording.stop`

Stops a specific, ongoing recording.

**Payload (JSON):**
```json
{
  "recording_id": "a1b2c3d4-e5f6-...",
  "transcribe_on_stop": true,
  "metadata": { "copy_to_clipboard": true }
}
```
-   **`transcribe_on_stop`**: If `true`, the service will automatically issue a `transcription.run` command internally upon successful completion.

### `speakr.command.recording.cancel`

Aborts an ongoing recording and discards all captured data.

**Payload (JSON):**
```json
{
  "recording_id": "a1b2c3d4-e5f6-..."
}
```

### `speakr.command.transcription.run`

Requests transcription of audio data. This is the primary workhorse command for transcription.

**Payload (JSON) - Option 1: By Recording ID**
```json
{
  "recording_id": "a1b2c3d4-e5f6-...",
  "tags": ["additional-tag"],
  "metadata": { "copy_to_clipboard": true }
}
```

**Payload (JSON) - Option 2: By Raw Data**
```json
{
  "audio_data": "BASE64_ENCODED_STRING_OF_AUDIO_FILE",
  "tags": ["project-y", "voicemail"],
  "metadata": { "source": "twilio-integration" }
}
```

---

## 2. Events

Events are messages emitted **from** the `speakr` service to notify consumers of a state change.

### `speakr.event.recording.started`

Published in response to a `recording.start` command.

**Payload (JSON):**
```json
{
  "recording_id": "a1b2c3d4-e5f6-...",
  "tags": ["project-x", "daily-standup"],
  "metadata": { "triggered_by": "cli-adapter" }
}
```

### `speakr.event.recording.finished`

Published when a recording is successfully stopped and the audio file is saved.

**Payload (JSON):**
```json
{
  "recording_id": "a1b2c3d4-e5f6-...",
  "audio_file_path": "/path/to/speakr/recordings/a1b2c3d4.wav",
  "tags": ["project-x", "daily-standup"],
  "metadata": { "copy_to_clipboard": true }
}
```

### `speakr.event.recording.cancelled`

Published when a recording has been cancelled.

**Payload (JSON):**
```json
{
  "recording_id": "a1b2c3d4-e5f6-..."
}
```

### `speakr.event.transcription.succeeded`

Published on successful transcription. This is the primary success event.

**Payload (JSON):**
```json
{
  "recording_id": "a1b2c3d4-e5f6-...",
  "transcribed_text": "The quick brown fox jumps over the lazy dog.",
  "tags": ["project-x", "daily-standup", "additional-tag"],
  "metadata": { "copy_to_clipboard": true }
}
```

### `speakr.event.transcription.failed`

Published if transcription fails for any reason.

**Payload (JSON):**
```json
{
  "recording_id": "a1b2c3d4-e5f6-...",
  "error": "The provided audio file is invalid or corrupted.",
  "tags": ["project-x", "daily-standup"],
  "metadata": { "copy_to_clipboard": true }
}
```

---

### Note on Clipboard Functionality

The `copy_to_clipboard` flag is handled by the **driving adapter** (e.g., the CLI), not the core service.

1.  The CLI adapter adds `"copy_to_clipboard": true` to the command's `metadata`.
2.  The core service is ignorant of this field; it simply ensures the `metadata` is passed through to the resulting events.
3.  The CLI adapter, when it receives a `transcription.succeeded` event, inspects the `metadata` field. If `copy_to_clipboard` is `true`, it then invokes its local clipboard functionality.

This maintains a clean separation of concerns.
